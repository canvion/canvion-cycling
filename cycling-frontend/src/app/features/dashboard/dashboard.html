<div class="layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">ğŸš´ Canvion</div>
    <nav>
      <a routerLink="/dashboard" class="nav-item active">ğŸ“Š Dashboard</a>
      <a routerLink="/activities" class="nav-item">ğŸƒ Actividades</a>
    </nav>
    <div class="sidebar-bottom">
      <span class="sidebar-user">ğŸ‘¤ {{ username }}</span>
      <button class="btn-logout" (click)="logout()">Salir</button>
    </div>
  </aside>

  <!-- Contenido principal -->
  <main class="main">

    <!-- Header -->
    <div class="top-bar">
      <h1>Dashboard</h1>
      <div class="strava-buttons">
        <button class="btn-strava" (click)="connectStrava()">ğŸ”— Conectar Strava</button>
        <button class="btn-sync" (click)="syncStrava()" [disabled]="isSyncing">
          {{ isSyncing ? 'Sincronizando...' : 'ğŸ”„ Sincronizar' }}
        </button>
      </div>
    </div>

    <!-- Mensaje de sincronizaciÃ³n -->
    <div class="sync-message" *ngIf="syncMessage">{{ syncMessage }}</div>

    <!-- Loading -->
    <app-spinner *ngIf="isLoading"></app-spinner>

    <div *ngIf="!isLoading">

      <!-- Filtro de periodo -->
      <div class="period-filter">
        <button [class.active]="selectedPeriod === 'month'" (click)="filterByPeriod('month')">Este mes</button>
        <button [class.active]="selectedPeriod === 'year'" (click)="filterByPeriod('year')">Este aÃ±o</button>
        <button [class.active]="selectedPeriod === 'all'" (click)="filterByPeriod('all')">Todo</button>
      </div>

      <!-- EstadÃ­sticas generales -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ…</div>
          <div class="stat-value">{{ totalActivities }}</div>
          <div class="stat-label">Actividades</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-value">{{ totalKm.toFixed(0) }} km</div>
          <div class="stat-label">Distancia total</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â±ï¸</div>
          <div class="stat-value">{{ totalHours.toFixed(0) }} h</div>
          <div class="stat-label">Horas en movimiento</div>
        </div>
      </div>

      <!-- Comparativa aÃ±o anterior -->
      <div class="year-comparison" *ngIf="lastYearActivities > 0">
        <h2>
          {{ selectedPeriod === 'month' ? 'Este mes' : selectedPeriod === 'year' ? 'Este aÃ±o' : 'Total' }}
          vs mismo periodo aÃ±o anterior
        </h2>
        <div class="comparison-grid">
          <div class="comparison-card">
            <div class="comparison-label">Actividades</div>
            <div class="comparison-values">
              <span class="current">{{ totalActivities }}</span>
              <span class="vs">vs</span>
              <span class="last">{{ lastYearActivities }}</span>
            </div>
            <div class="diff" [class.positive]="isPositive(totalActivities, lastYearActivities)">
              {{ getDiff(totalActivities, lastYearActivities) }}
            </div>
          </div>
          <div class="comparison-card">
            <div class="comparison-label">KilÃ³metros</div>
            <div class="comparison-values">
              <span class="current">{{ totalKm.toFixed(0) }}</span>
              <span class="vs">vs</span>
              <span class="last">{{ lastYearKm.toFixed(0) }}</span>
            </div>
            <div class="diff" [class.positive]="isPositive(totalKm, lastYearKm)">
              {{ getDiff(totalKm, lastYearKm) }}
            </div>
          </div>
          <div class="comparison-card">
            <div class="comparison-label">Horas</div>
            <div class="comparison-values">
              <span class="current">{{ totalHours.toFixed(0) }}</span>
              <span class="vs">vs</span>
              <span class="last">{{ lastYearHours.toFixed(0) }}</span>
            </div>
            <div class="diff" [class.positive]="isPositive(totalHours, lastYearHours)">
              {{ getDiff(totalHours, lastYearHours) }}
            </div>
          </div>
        </div>
      </div>

      <!-- GrÃ¡fico y Ãºltimas actividades -->
      <div class="bottom-grid">

        <!-- GrÃ¡fico por mes -->
        <div class="card">
          <h2>Actividades por mes</h2>
          <div class="chart-container">
            <div class="bar-chart">
              <div class="bar-group" *ngFor="let value of chartData; let i = index">
                <div class="bar-wrap">
                  <span class="bar-num">{{ value }}</span>
                  <div class="bar" [style.height.%]="value === 0 ? 2 : (value / maxChartValue) * 100"></div>
                </div>
                <span class="bar-label">{{ chartLabels[i] }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Ãšltimas actividades -->
        <div class="card">
          <div class="card-header">
            <h2>Ãšltimas actividades</h2>
            <a routerLink="/activities" class="ver-todas">Ver todas â†’</a>
          </div>
          <div class="activity-list">
            <div class="activity-item" *ngFor="let activity of lastActivities">
              <div class="activity-icon">
                {{ activity.type === 'Ride' ? 'ğŸš´' : activity.type === 'Run' ? 'ğŸƒ' : 'ğŸŠ' }}
              </div>
              <div class="activity-info">
                <span class="activity-name">{{ activity.name }}</span>
                <span class="activity-meta">{{ formatKm(activity.distance) }} km Â· {{ formatTime(activity.movingTime) }}</span>
              </div>
              <div class="activity-date">
                {{ activity.startDate | date:'dd/MM' }}
              </div>
            </div>
            <p class="no-data" *ngIf="lastActivities.length === 0">
              Sin actividades. Â¡Sincroniza con Strava!
            </p>
          </div>
        </div>

      </div>
    </div>

  </main>
</div>
